#!/usr/bin/env sh
set -euo pipefail

echo "[husky pre-commit] Quick hygiene checks"

# Prevent committing secrets file (defense-in-depth)
if git diff --cached --name-only | grep -qE '^app\.env$'; then
  echo "[husky] ERROR: app.env is staged. Remove it from the commit (secrets must not be committed)." >&2
  exit 1
fi

# Prevent committing runtime data accidentally
if git diff --cached --name-only | grep -qE '^(uploads/|backups/)'; then
  echo "[husky] ERROR: runtime data (uploads/ or backups/) is staged. Remove it from the commit." >&2
  exit 1
fi

# Optional: run Prettier on staged files if present (format only staged files)
if command -v npx >/dev/null 2>&1; then
  STAGED="$(git diff --cached --name-only --diff-filter=ACMRT | grep -E '\\.(ts|tsx|js|jsx|mjs|cjs|json|md|css|scss)$' || true)"
  if [ -n "$STAGED" ]; then
    echo "$STAGED" | xargs npx prettier -u -w --log-level error || true
    echo "$STAGED" | xargs git add -A || true
  fi
fi

echo "[husky pre-commit] Quick lint + migration check"
npm run lint --silent
node scripts/check-migrations.mjs
echo "[husky pre-commit] OK"
