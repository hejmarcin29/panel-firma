<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wybierz Paczkomat | InPost</title>
    <link rel="stylesheet" href="https://geowidget.inpost.pl/inpost-geowidget.css"/>
    <script src="https://geowidget.inpost.pl/inpost-geowidget.js" defer></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f0f0f0; font-family: sans-serif; }
        #loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100vw; position: absolute; top:0; left: 0; z-index: -1; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: #ffcc00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Force modal to fill screen if it doesn't */
        .easy-pack-modal { width: 100% !important; height: 100% !important; max-width: 100% !important; max-height: 100% !important; top: 0 !important; left: 0 !important; margin: 0 !important; border-radius: 0 !important; }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: #666;">Ładowanie mapy...</p>
    </div>

    <script>
        // Pobierz token z URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        window.easyPackAsyncInit = function () {
            const config = {
                defaultLocale: 'pl',
                mapType: 'osm',
                searchType: 'osm',
                points: { types: ['parcel_locker', 'pop'] },
                map: { useGeolocation: true }
            };

            // Jeśli podano token, dodaj go do konfiguracji
            if (token) {
                // Token usuwa limity i blokady domenowe
                // InPost wymaga tokena string
                // config.token = token; // Stara dokumentacja
                // Nowa dokumentacja może wymagać innego parametru, ale
                // w większości przypadków geowidget.inpost.pl sam wykrywa domenę.
                // Jednak dla pewności przekażmy go, jeśli API na to pozwala.
                // Uwaga: standardowy config init() w dokumentacji geowidgetu 
                // nie zawsze wymienia 'token', ale często jest on wymagany w <script src="...&token=XYZ">
                // lub jako parametr inicjalizacji. Weryfikacja:
                // Zwykle geowidget v5 konfiguruje się przez easyPack.init({ instance: 'PL', ... })
                // Sprawdźmy czy można dodać token.
            }

            // Wg dokumentacji GeoWidget v4/v5 token podaje się przy inicjalizacji, jeśli używamy
            // wersji z autoryzacją.
            // Spróbujmy przekazać go w obiekcie config, jeśli istnieje.
            // Ale uwaga: token jest często weryfikowany per domena.
            
            // Wersja "bezpieczna": Jeśli mamy token, dodajemy go.
            // Jeśli nie - działamy w trybie OSM (open).
            
            // WAŻNE: W dokumentacji InPost często token jest po prostu
            // identyfikatorem klienta.
            
            // Update: Poprawna metoda to przekazanie apiToken / token w zależności od wersji.
            // Zakładamy że user ma token (API Key) do GeoWidgetu.
        
            window.easyPack.init(token ? { ...config, token: token } : config);

            var widget = window.easyPack.modalMap(function(point, modal) {
                // Obsługa iframe (parent) oraz popup (opener)
                var target = window.parent || window.opener;
                if (target) {
                    target.postMessage({
                        type: 'INPOST_SELECTION',
                        point: {
                            name: point.name,
                            address: point.address_details.street + ' ' + point.address_details.building_number + ', ' + point.address_details.city,
                            full_point: point
                        }
                    }, '*');
                }
                modal.closeModal();
                // Nie zamykamy okna automatycznie jeśli to iframe, ale jeśli popup to tak.
                if (window.opener) {
                    window.close();
                }
            }, {
                width: '100%',
                height: '100%',
                defaultLocale: 'pl',
                closeText: 'Zamknij'
            });
            
            widget.open();
        };
    </script>
</body>
</html>